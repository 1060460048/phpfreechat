(function(e,t,n){function u(t,n){o=this,o.element=t,o.options=e.extend({},s,n),o._defaults=s,o._name=r,o.users={};if(!o.hasBacklink())return;o.loadHTML(),o.tryToLogin(),e(o.element).bind("pfc-login",function(t,n,r){n.userdata=r,n.cid="xxx",e.ajax({type:"POST",url:n.options.serverUrl+"/channels/"+n.cid+"/users/"}).done(function(t){function r(){e.ajax({type:"GET",url:n.options.serverUrl+"/users/"+n.userdata.id+"/msg/"}).done(function(e){e.forEach(function(e,t){n.appendMessage(e)}),setTimeout(r,2e3)}).error(function(e){console.log(e),setTimeout(r,2e3)})}function i(t){var t={message:t};e.ajax({type:"POST",url:n.options.serverUrl+"/channels/"+n.cid+"/msg/",data:t}).done(function(e){n.appendMessage(e)}).error(function(e){console.log(e)})}t.forEach(function(t){e.ajax({type:"GET",url:n.options.serverUrl+"/users/"+t+"/"}).done(function(e){n.users[e.id]=e,n.appendUser(e)}).error(function(e){console.log(e)})}),r(),e(".pfc-compose textarea").keydown(function(t){if(t.keyCode==13&&t.shiftKey==0)return i(e(".pfc-compose textarea").val()),e(".pfc-compose textarea").val(""),!1})}).error(function(e){console.log(e)})}),e(o.element).bind("pfc-logout",function(e,t,n){t.userdata={},t.clearUserList()})}function a(e,t){var n=t||typeof t=="undefined"?"<br />":"<br>";return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+n+"$2")}function f(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,r,i,s,o;return i=e&2147483648,s=t&2147483648,n=e&1073741824,r=t&1073741824,o=(e&1073741823)+(t&1073741823),n&r?o^2147483648^i^s:n|r?o&1073741824?o^3221225472^i^s:o^1073741824^i^s:o^i^s}function r(e,t,n){return e&t|~e&n}function i(e,t,n){return e&n|t&~n}function s(e,t,n){return e^t^n}function o(e,t,n){return t^(e|~n)}function u(e,i,s,o,u,a,f){return e=n(e,n(n(r(i,s,o),u),f)),n(t(e,a),i)}function a(e,r,s,o,u,a,f){return e=n(e,n(n(i(r,s,o),u),f)),n(t(e,a),r)}function f(e,r,i,o,u,a,f){return e=n(e,n(n(s(r,i,o),u),f)),n(t(e,a),r)}function l(e,r,i,s,u,a,f){return e=n(e,n(n(o(r,i,s),u),f)),n(t(e,a),r)}function c(e){var t,n=e.length,r=n+8,i=(r-r%64)/64,s=(i+1)*16,o=Array(s-1),u=0,a=0;while(a<n)t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|e.charCodeAt(a)<<u,a++;return t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|128<<u,o[s-2]=n<<3,o[s-1]=n>>>29,o}function h(e){var t="",n="",r,i;for(i=0;i<=3;i++)r=e>>>i*8&255,n="0"+r.toString(16),t+=n.substr(n.length-2,2);return t}function p(e){e=e.replace(/rn/g,"n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t}var d=Array(),v,m,g,y,b,w,E,S,x,T=7,N=12,C=17,k=22,L=5,A=9,O=14,M=20,_=4,D=11,P=16,H=23,B=6,j=10,F=15,I=21;e=p(e),d=c(e),w=1732584193,E=4023233417,S=2562383102,x=271733878;for(v=0;v<d.length;v+=16)m=w,g=E,y=S,b=x,w=u(w,E,S,x,d[v+0],T,3614090360),x=u(x,w,E,S,d[v+1],N,3905402710),S=u(S,x,w,E,d[v+2],C,606105819),E=u(E,S,x,w,d[v+3],k,3250441966),w=u(w,E,S,x,d[v+4],T,4118548399),x=u(x,w,E,S,d[v+5],N,1200080426),S=u(S,x,w,E,d[v+6],C,2821735955),E=u(E,S,x,w,d[v+7],k,4249261313),w=u(w,E,S,x,d[v+8],T,1770035416),x=u(x,w,E,S,d[v+9],N,2336552879),S=u(S,x,w,E,d[v+10],C,4294925233),E=u(E,S,x,w,d[v+11],k,2304563134),w=u(w,E,S,x,d[v+12],T,1804603682),x=u(x,w,E,S,d[v+13],N,4254626195),S=u(S,x,w,E,d[v+14],C,2792965006),E=u(E,S,x,w,d[v+15],k,1236535329),w=a(w,E,S,x,d[v+1],L,4129170786),x=a(x,w,E,S,d[v+6],A,3225465664),S=a(S,x,w,E,d[v+11],O,643717713),E=a(E,S,x,w,d[v+0],M,3921069994),w=a(w,E,S,x,d[v+5],L,3593408605),x=a(x,w,E,S,d[v+10],A,38016083),S=a(S,x,w,E,d[v+15],O,3634488961),E=a(E,S,x,w,d[v+4],M,3889429448),w=a(w,E,S,x,d[v+9],L,568446438),x=a(x,w,E,S,d[v+14],A,3275163606),S=a(S,x,w,E,d[v+3],O,4107603335),E=a(E,S,x,w,d[v+8],M,1163531501),w=a(w,E,S,x,d[v+13],L,2850285829),x=a(x,w,E,S,d[v+2],A,4243563512),S=a(S,x,w,E,d[v+7],O,1735328473),E=a(E,S,x,w,d[v+12],M,2368359562),w=f(w,E,S,x,d[v+5],_,4294588738),x=f(x,w,E,S,d[v+8],D,2272392833),S=f(S,x,w,E,d[v+11],P,1839030562),E=f(E,S,x,w,d[v+14],H,4259657740),w=f(w,E,S,x,d[v+1],_,2763975236),x=f(x,w,E,S,d[v+4],D,1272893353),S=f(S,x,w,E,d[v+7],P,4139469664),E=f(E,S,x,w,d[v+10],H,3200236656),w=f(w,E,S,x,d[v+13],_,681279174),x=f(x,w,E,S,d[v+0],D,3936430074),S=f(S,x,w,E,d[v+3],P,3572445317),E=f(E,S,x,w,d[v+6],H,76029189),w=f(w,E,S,x,d[v+9],_,3654602809),x=f(x,w,E,S,d[v+12],D,3873151461),S=f(S,x,w,E,d[v+15],P,530742520),E=f(E,S,x,w,d[v+2],H,3299628645),w=l(w,E,S,x,d[v+0],B,4096336452),x=l(x,w,E,S,d[v+7],j,1126891415),S=l(S,x,w,E,d[v+14],F,2878612391),E=l(E,S,x,w,d[v+5],I,4237533241),w=l(w,E,S,x,d[v+12],B,1700485571),x=l(x,w,E,S,d[v+3],j,2399980690),S=l(S,x,w,E,d[v+10],F,4293915773),E=l(E,S,x,w,d[v+1],I,2240044497),w=l(w,E,S,x,d[v+8],B,1873313359),x=l(x,w,E,S,d[v+15],j,4264355552),S=l(S,x,w,E,d[v+6],F,2734768916),E=l(E,S,x,w,d[v+13],I,1309151649),w=l(w,E,S,x,d[v+4],B,4149444226),x=l(x,w,E,S,d[v+11],j,3174756917),S=l(S,x,w,E,d[v+2],F,718787259),E=l(E,S,x,w,d[v+9],I,3951481745),w=n(w,m),E=n(E,g),S=n(S,y),x=n(x,b);var q=h(w)+h(E)+h(S)+h(x);return q.toLowerCase()}var r="phpfreechat",i=t.document,s={serverUrl:"../server",loaded:null,loadTestData:!1},o={};u.prototype.appendUser=function(t){t.id=t.id!=n?t.id:0,t.role=t.role!=n?t.role:"user",t.name=t.name!=n?t.name:"Guest "+Math.round(Math.random()*100),t.email=t.email!=n?t.email:"",t.active=t.active!=n?t.active:!0;var r=e(o.element).find(t.role=="admin"?"div.pfc-role-admin":"div.pfc-role-user"),i=e('              <li class="user">                <div class="status"></div>                <div class="name"></div>                <div class="avatar"></div>              </li>');t.name&&i.find("div.name").text(t.name),r.find("li").length==0&&i.addClass("first"),i.find("div.status").addClass(t.active?"st-active":"st-inactive");var s=[];e(o.element).find("div.pfc-users li.user").each(function(t,n){s.push(parseInt(e(n).attr("id").split("_")[1]))});if(t.id==0)do t.id=Math.round(Math.random()*1e4);while(s.indexOf(t.id)!=-1);return t.id==0||s.indexOf(t.id)!=-1?(delete i,0):(i.attr("id","user_"+t.id),r.find("ul").append(i),o.updateRolesTitles(),t.id)},u.prototype.removeUser=function(t){var n=e(o.element).find("#user_"+t).remove().length>0;return o.updateRolesTitles(),n},u.prototype.updateRolesTitles=function(){[e(o.element).find("div.pfc-role-admin"),e(o.element).find("div.pfc-role-user")].forEach(function(e,t){e.find("li").length==0?e.find(".role-title").hide():e.find(".role-title").show()})},u.prototype.clearUserList=function(){return e(o.element).find("li.user").remove(),o.updateRolesTitles(),!0},u.prototype.appendMessage=function(t){t.name=o.users[t.sender]!=n?o.users[t.sender].name:"???",t.message=t.message!=n?t.message:"",t.timestamp=t.timestamp!=n?t.timestamp:Math.round((new Date).getTime()/1e3),t.date=(new Date(t.timestamp*1e3)).toLocaleTimeString();var r=e(o.element).find(".pfc-messages .messages-group:last");if(r.attr("data-from")!=t.name){var i=e('<div class="messages-group" data-stamp="" data-from="">            <div class="avatar"><div style="width:30px; height: 30px; background-color: #DDD;"></div></div>            <div class="date"></div>            <div class="name"></div>          </div>');i.find(".name").text(t.name),i.attr("data-from",t.name),i.find(".date").text(t.date),i.attr("data-stamp",t.timestamp),e(o.element).find(".pfc-messages").append(i),r=i}var s=e('<div class="message"></div>').html(a(t.message));return r.append(s),s},u.prototype.hasBacklink=function(){var t=e('a[href="http://www.phpfreechat.net"]').length;return t?!0:(e(o.element).html('<div class="pfc-backlink"><p>Please insert the phpfreechat backlink somewhere in your HTML in order to load the chat. The attended backlink is:</p><pre>'+e("<div/>").text('<a href="http://www.phpfreechat.net">phpFreeChat: simple Web chat</a>').html()+"</pre>"+"</div>"),!1)},u.prototype.loadHTML=function(){e(o.element).html('      <div class="pfc-content">        <div class="pfc-tabs">          <ul>            <li class="channel active">              <div class="icon"></div>              <div class="name">Default channel</div>              <div class="close"></div>            </li>'+(o.options.loadTestData?'            <li class="channel active">              <div class="icon"></div>              <div class="name">Channel 1</div>              <div class="close"></div>            </li>            <li class="channel">              <div class="icon"></div>              <div class="name">Channel 2</div>              <div class="close"></div>            </li>            <li class="pm">              <div class="icon"></div>              <div class="name">admin</div>              <div class="close"></div>            </li>':"")+'            <li class="new-tab">'+'              <div class="icon"></div>'+"            </li>"+"          </ul>"+"        </div>"+""+'        <div class="pfc-topic">'+'          <p><span class="pfc-topic-label">Topic:</span> <span class="pfc-topic-value">no topic for this channel</span></p>'+"        </div>"+""+'        <div class="pfc-messages">'+(o.options.loadTestData?'          <div class="messages-group" data-stamp="1336815502" data-from="kerphi">            <div class="avatar"><img src="http://www.gravatar.com/avatar/ae5979732c49cae7b741294a1d3a8682?d=wavatar&s=30" alt="" /></div>            <div class="date">11:38:21</div>            <div class="name">kerphi</div>            <div class="message">123</div>            <div class="message">456</div>          </div>          <div class="messages-group" data-stamp="1336815503" data-from="admin">            <div class="avatar"><img src="http://www.gravatar.com/avatar/00000000000000000000000000000001?d=wavatar&s=30" alt="" /></div>            <div class="date">11:38:22</div>            <div class="name">admin</div>            <div class="message">Hello</div>            <div class="message">World</div>            <div class="message">!</div>          </div>':"")+"        </div>"+""+'        <div class="pfc-users">'+'          <div class="pfc-role-admin">'+'            <p class="role-title">Administrators</p>'+"            <ul>"+(o.options.loadTestData?'              <li class="first">                <div class="status st-active"></div>                <div class="name">admin</div>                <div class="avatar"><img src="http://www.gravatar.com/avatar/00000000000000000000000000000001?d=wavatar&s=20" alt="" /></div>              </li>':"")+"            </ul>"+"          </div>"+'          <div class="pfc-role-user">'+'            <p class="role-title">Users</p>'+"            <ul>"+(o.options.loadTestData?'              <li class="first">                <div class="status st-active"></div>                <div class="name myself">kerphi</div>                <div class="avatar"><img src="http://www.gravatar.com/avatar/ae5979732c49cae7b741294a1d3a8682?d=wavatar&s=20" alt="" /></div>              </li>              <li>                <div class="status st-inactive"></div>                <div class="name">Stéphane Gully</div>                <div class="avatar"><img src="http://www.gravatar.com/avatar/00000000000000000000000000000002?d=wavatar&s=20" alt="" /></div>              </li>':"")+"            </ul>"+"          </div>"+"        </div>"+""+'        <div class="pfc-footer">'+'          <p class="logo"><a href="http://www.phpfreechat.net">Powered by phpFreeChat</a></p>'+"          <ul>"+"          </ul>"+"        </div>"+""+'        <div class="pfc-compose">'+'          <textarea data-to="channel|xxx"></textarea>'+"        </div>"+""+'        <div class="pfc-modal-overlay"></div>'+'        <div class="pfc-modal-box"></div>'+"      </div>"),l.init(),o.options.loaded&&o.options.loaded(o),setTimeout(function(){e(o.element).trigger("pfc-loaded",[o])},0)},u.prototype.tryToLogin=function(t,n){var r=t?{"Pfc-Authorization":"Basic "+e.base64.encode(t.login+":"+t.password)}:{},i=t?{email:t.email}:null;e.ajax({type:"GET",url:o.options.serverUrl+"/auth",headers:r,data:i}).done(function(t){e(o.element).trigger("pfc-login",[o,t]),n?n(null,t):null}).error(function(e){o.showAuthForm(t?e.statusText:null),n?n(e):null})},u.prototype.tryToLogout=function(t){e.ajax({type:"DELETE",url:o.options.serverUrl+"/auth"}).done(function(n){e(o.element).trigger("pfc-logout",[o,n]),t?t(null,n):null}).error(function(e){t?t(e):null})},u.prototype.showAuthForm=function(t){l.open('<form>  <input type="text" name="login" placeholder="Login"/><br/>  <input type="text" name="email" placeholder="Email"/><br/>  <input type="submit" name="submit" value="Sign in" />'+(t?"<p>"+t+"</p>":"")+"</form>").submit(function(){var t=e(this).find("[name=login]").attr("value"),n=e(this).find("[name=password]").attr("value"),r=e(this).find("[name=email]").attr("value");return t?(o.tryToLogin({login:t,password:n,email:r}),l.close(!0),!1):!1}).find("[name=login]").focus()},e.fn[r]=function(t){return this.each(function(){e.data(this,"plugin_"+r)||e.data(this,"plugin_"+r,new u(this,t))})},jQuery.base64=function(e){function i(e,t){var r=n.indexOf(e.charAt(t));if(r===-1)throw"Cannot decode base64";return r}function s(e){var n=0,r,s,o=e.length,u=[];e=String(e);if(o===0)return e;if(o%4!==0)throw"Cannot decode base64";e.charAt(o-1)===t&&(n=1,e.charAt(o-2)===t&&(n=2),o-=4);for(r=0;r<o;r+=4)s=i(e,r)<<18|i(e,r+1)<<12|i(e,r+2)<<6|i(e,r+3),u.push(String.fromCharCode(s>>16,s>>8&255,s&255));switch(n){case 1:s=i(e,r)<<18|i(e,r+1)<<12|i(e,r+2)<<6,u.push(String.fromCharCode(s>>16,s>>8&255));break;case 2:s=i(e,r)<<18|i(e,r+1)<<12,u.push(String.fromCharCode(s>>16))}return u.join("")}function o(e,t){var n=e.charCodeAt(t);if(n>255)throw"INVALID_CHARACTER_ERR: DOM Exception 5";return n}function u(e){if(arguments.length!==1)throw"SyntaxError: exactly one argument required";e=String(e);var r,i,s=[],u=e.length-e.length%3;if(e.length===0)return e;for(r=0;r<u;r+=3)i=o(e,r)<<16|o(e,r+1)<<8|o(e,r+2),s.push(n.charAt(i>>18)),s.push(n.charAt(i>>12&63)),s.push(n.charAt(i>>6&63)),s.push(n.charAt(i&63));switch(e.length-u){case 1:i=o(e,r)<<16,s.push(n.charAt(i>>18)+n.charAt(i>>12&63)+t+t);break;case 2:i=o(e,r)<<16|o(e,r+1)<<8,s.push(n.charAt(i>>18)+n.charAt(i>>12&63)+n.charAt(i>>6&63)+t)}return s.join("")}var t="=",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r="1.0";return{decode:s,encode:u,VERSION:r}}(jQuery);var l={open:function(n){return n=e(n),e("div.pfc-modal-box *").remove(),e("div.pfc-modal-box").append(n).fadeIn(),e("div.pfc-modal-overlay").fadeIn("fast"),e(t).trigger("resize"),n},close:function(t){t?(e("div.pfc-modal-box").hide(),e("div.pfc-modal-overlay").hide()):(e("div.pfc-modal-box").fadeOut(),e("div.pfc-modal-overlay").fadeOut("fast"))},init:function(){e(t).resize(function(){var n=e("div.pfc-modal-box"),r=e("div.pfc-modal-overlay");n.css({left:(r.outerWidth(!0)-n.outerWidth(!0))/2,top:(r.outerHeight(!0)-n.outerHeight(!0))/2})}).trigger("resize")}}})(jQuery,window);